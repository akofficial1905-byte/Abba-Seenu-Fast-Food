<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Abba SEENUUU... FAST FOODS ‚Äî Manager Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Socket.io (same origin backend) -->
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .order-type-badge { font-size:11px; font-weight:600; border-radius:999px; padding:2px 10px; margin-right:6px }
    .order-type-dinein { background:#fbbf24; color:#222; }
    .order-type-takeaway { background:#34d399; color:#222; }
    .order-type-delivery { background:#60a5fa; color:#fff; }

    .insight-label { color:#b45309; font-weight:700; font-size:0.98rem; letter-spacing:.4px; text-transform:uppercase; }
    .insight-select, .insight-input, #dashboardDate, #dashboardPeriod {
      font-weight:700; font-size:0.95rem; background:#fffbe0; color:#7c4700;
      border:2.5px solid #f59e0b; border-radius:999px; padding:7px 16px; margin:0 6px 6px 0;
      box-shadow:0 0 0 1px rgba(245,158,11,0.4);
    }
    .insight-box {
      background:#fffbe8; border:3px solid #fbbf24; border-radius:18px;
      padding:18px; margin-top:10px; color:#4c1d06; font-size:0.95rem;
    }
    .insight-result-table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    .insight-result-table th, .insight-result-table td {
      border-bottom:2px solid #fbbf24; padding:8px 10px; text-align:left;
    }
    .insight-big-value { font-size:1.25rem; font-weight:800; color:#a16207; line-height:1.4; }
    .insight-mid-value { font-size:0.95rem; font-weight:700; }
    .dashboard-label { font-size:0.95rem; font-weight:800; color:#92400e; padding-right:8px; text-transform:uppercase; }

    .tab-btn {
      padding:0.4rem 1rem;
      font-size:0.8rem;
      font-weight:600;
      border-radius:999px;
      border:1px solid rgb(251,191,36);
      color:rgb(252,211,77);
      background-color:rgb(15,23,42);
    }
    .tab-btn-active {
      background-color:rgb(251,191,36);
      color:black;
      box-shadow:0 0 0 1px rgba(0,0,0,0.1);
    }

    .order-card-title { font-size:0.95rem; font-weight:700; }
    .order-card-meta { font-size:0.75rem; }
    .order-card-items { font-size:0.8rem; }

    @media (max-width:700px){
      .max-w-7xl { max-width:100vw !important; padding:10px !important; }
      header h1 { font-size:1.4rem; }
      header p { font-size:0.7rem; }
      .p-6, .py-10, .px-8, .mb-8, .my-10 { padding:10px !important; margin:8px 0 !important; }
      .grid { gap:10px !important; }
      .dashboard-label { font-size:0.85rem; }

      .flex-wrap-row {
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }

      .insight-select, .insight-input, #dashboardDate, #dashboardPeriod {
        width:100%;
        max-width:none;
        display:block;
      }

      .orders-date-row {
        flex-direction:column;
        align-items:flex-start;
      }
      .orders-date-row > div {
        width:100%;
      }
      #datePicker {
        width:100%;
      }
    }

    .table-wrapper { overflow-x:auto; }

    /* Inventory toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }
    .switch input { display:none; }
    .slider {
      position:absolute;
      cursor:pointer;
      top:0; left:0; right:0; bottom:0;
      background-color:#4b5563;
      transition:.3s;
      border-radius:999px;
    }
    .slider:before {
      position:absolute;
      content:"";
      height:18px;
      width:18px;
      left:3px;
      bottom:3px;
      background-color:white;
      transition:.3s;
      border-radius:999px;
    }
    .switch input:checked + .slider {
      background-color:#22c55e;
    }
    .switch input:checked + .slider:before {
      transform:translateX(22px);
    }

    /* Simple login overlay */
    #loginOverlay {
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-900 via-gray-900 to-black text-gray-100 min-h-screen">

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div class="bg-slate-900 border border-amber-400 rounded-2xl px-6 py-6 w-80 shadow-2xl">
      <h2 class="text-xl font-extrabold text-amber-300 mb-2 text-center">
        Manager Login
      </h2>
      <p class="text-xs text-gray-400 mb-4 text-center">
        Only staff are allowed to access this portal.
      </p>
      <label class="block text-xs font-semibold text-gray-200 mb-1">Username</label>
      <input id="loginUser" class="w-full mb-3 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <label class="block text-xs font-semibold text-gray-200 mb-1">Password</label>
      <input id="loginPass" type="password" class="w-full mb-4 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <button id="loginBtn"
        class="w-full bg-amber-400 hover:bg-amber-500 text-black font-semibold rounded-full py-2 text-sm">
        Login
      </button>
      <div id="loginError" class="text-xs text-red-400 mt-2 hidden">
        Wrong username or password.
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="managerApp" class="max-w-7xl mx-auto p-6" style="display:none;">
    <header class="flex justify-between items-center mb-4 gap-2">
      <div>
        <h1 class="text-2xl md:text-4xl font-extrabold text-amber-300">
          Abba SEENUUU... FAST FOODS ‚Äî Manager
        </h1>
        <p class="text-[11px] md:text-xs text-gray-400">
          Contact: <b>+91-XXXXXXXXXX</b> ‚Ä¢ Live orders, dashboards, Bluetooth &amp; PC print
        </p>
      </div>
      <div class="flex flex-col items-end gap-2">
        <!-- Restaurant ON/OFF switch -->
        <div class="flex items-center gap-2 text-[11px] md:text-xs text-gray-200">
          <span id="restStatusLabel">Restaurant: ON</span>
          <label class="switch">
            <input type="checkbox" id="restStatusToggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <button id="openChangeLogin"
          class="px-3 py-1 rounded-full text-[11px] md:text-xs bg-red-500 text-white">
          Change Login
        </button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex gap-2 mb-4">
      <button id="tabOrders"   class="tab-btn tab-btn-active text-xs md:text-sm">Orders</button>
      <button id="tabAnalytics" class="tab-btn text-xs md:text-sm">Analytics &amp; Insights</button>
      <button id="tabInventory" class="tab-btn text-xs md:text-sm">Inventory</button>
    </div>

    <!-- ORDERS TAB -->
    <div id="ordersTab">
      <div class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4 mb-4">
        <div class="flex justify-between items-center gap-3 flex-wrap orders-date-row">
          <div class="flex items-center gap-2">
            <span class="dashboard-label">Orders for</span>
            <input id="datePicker" type="date"
              class="bg-slate-800 border border-amber-400 rounded-full px-3 py-1.5 text-xs md:text-sm" />
          </div>
          <div class="text-[11px] md:text-xs text-gray-400">
            Showing orders for selected date. Auto-refreshes on every new order.
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- Live / Pending -->
        <div class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4">
          <h2 class="text-sm md:text-base font-bold mb-3 flex items-center gap-2">
            <span class="inline-flex w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Live Orders
          </h2>
          <div id="ordersList" class="space-y-3 text-sm max-h-[70vh] overflow-y-auto pr-1"></div>
        </div>

        <!-- Delivered / History -->
        <div class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4">
          <h2 class="text-sm md:text-base font-bold mb-3 flex items-center gap-2">
            Order History
          </h2>
          <div id="historyList" class="space-y-3 text-sm max-h-[70vh] overflow-y-auto pr-1"></div>
        </div>
      </div>
    </div>

    <!-- ANALYTICS TAB -->
    <div id="analyticsTab" style="display:none;">
      <section class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4 md:p-6 mb-4">
        <h2 class="text-lg md:text-xl font-extrabold text-amber-300 mb-3">
          Daily Snapshot
        </h2>
        <div class="flex flex-wrap items-center gap-3 mb-4 flex-wrap-row">
          <div class="flex items-center">
            <span class="dashboard-label">Summary for</span>
            <input id="dashboardDate" type="date" class="insight-input" />
          </div>
          <div class="flex items-center">
            <span class="dashboard-label">Period</span>
            <select id="dashboardPeriod" class="insight-select">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="bg-amber-100 rounded-xl p-3 shadow text-slate-900">
            <div class="text-xs font-semibold text-amber-700 uppercase mb-1">Total Sales (‚Çπ)</div>
            <div id="sales-today" class="text-2xl font-extrabold">‚Çπ0</div>
          </div>
          <div class="bg-amber-100 rounded-xl p-3 shadow text-slate-900">
            <div class="text-xs font-semibold text-amber-700 uppercase mb-1">Total Orders</div>
            <div id="orders-month" class="text-2xl font-extrabold">0</div>
          </div>
          <div class="bg-amber-100 rounded-xl p-3 shadow text-slate-900">
            <div class="text-xs font-semibold text-amber-700 uppercase mb-1">Peak Hour</div>
            <div id="peak-hour" class="text-2xl font-extrabold">-</div>
          </div>
        </div>
      </section>

      <section class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4 md:p-6">
        <h2 class="text-lg md:text-xl font-extrabold text-amber-300 mb-3">
          Smart Insights
        </h2>

        <div class="flex flex-wrap gap-3 mb-3 flex-wrap-row">
          <div>
            <div class="insight-label mb-1">Insight Type</div>
            <select id="insightType" class="insight-select">
              <option value="">Choose insight</option>
              <option value="compare_sales">Compare Sales</option>
              <option value="repeat_customers">Repeat Customers</option>
              <option value="best_dish">Best Dish</option>
              <option value="customer_search">Customer Visits</option>
            </select>
          </div>

          <div>
            <div class="insight-label mb-1">From</div>
            <input id="insightFrom" type="date" class="insight-input" />
          </div>

          <div>
            <div class="insight-label mb-1">To</div>
            <input id="insightTo" type="date" class="insight-input" />
          </div>

          <div id="compareByLabel" style="display:none;">
            <div class="insight-label mb-1">Compare By</div>
            <select id="compareBy" class="insight-select">
              <option value="day">Day</option>
              <option value="week">Week</option>
              <option value="month">Month</option>
            </select>
          </div>

          <div>
            <div class="insight-label mb-1">Customer Name</div>
            <input id="insightName" class="insight-input" placeholder="For customer search" style="display:none;" />
          </div>

          <div class="flex items-end">
            <button onclick="runInsight()"
              class="px-4 py-2 rounded-full bg-amber-400 text-black font-semibold text-xs md:text-sm">
              Run Insight
            </button>
          </div>
        </div>

        <div id="insightResult" class="insight-box">
          Choose an insight and date range to see details.
        </div>
      </section>
    </div>

    <!-- INVENTORY TAB -->
    <div id="inventoryTab" style="display:none;">
      <section class="bg-slate-900/70 rounded-2xl border border-slate-700 p-4 md:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
          <div>
            <h2 class="text-lg md:text-xl font-extrabold text-amber-300">
              Inventory &amp; Menu Availability
            </h2>
            <p class="text-xs md:text-sm text-gray-300">
              Quickly switch items ON/OFF for the Abba SEENUUU... FAST FOODS online menu.
              Changes are saved to <b>menu.json</b> on the server.
            </p>
          </div>
          <div class="flex flex-col items-end gap-1">
            <button id="saveInventoryBtn"
              class="px-4 py-2 rounded-full bg-emerald-500 text-black font-semibold text-xs md:text-sm">
              Save Changes
            </button>
            <div id="inventoryStatus" class="text-[11px] text-emerald-400 hidden">
              Menu updated successfully.
            </div>
          </div>
        </div>

        <div class="table-wrapper mt-2">
          <table class="w-full text-xs md:text-sm">
            <thead>
              <tr class="border-b border-amber-400 text-amber-200">
                <th class="text-left py-2">Category</th>
                <th class="text-left py-2">Item</th>
                <th class="text-left py-2">Variants</th>
                <th class="text-center py-2">Available</th>
              </tr>
            </thead>
            <tbody id="inventoryTableBody" class="text-gray-100"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- CHANGE LOGIN MODAL -->
  <div id="changeLoginModal"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50"
    style="display:none;">
    <div class="bg-slate-900 rounded-2xl border border-amber-400 p-5 w-80">
      <h2 class="text-lg font-extrabold text-amber-300 mb-2 text-center">Change Manager Login</h2>
      <p class="text-[11px] text-gray-400 mb-3 text-center">
        Enter current and new credentials for Abba SEENUUU... FAST FOODS manager portal.
      </p>
      <label class="block text-xs font-semibold text-gray-200 mb-1">Current Username</label>
      <input id="curUser" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <label class="block text-xs font-semibold text-gray-200 mb-1">Current Password</label>
      <input id="curPass" type="password" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <label class="block text-xs font-semibold text-gray-200 mb-1">New Username</label>
      <input id="newUser" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <label class="block text-xs font-semibold text-gray-200 mb-1">New Password</label>
      <input id="newPass" type="password" class="w-full mb-3 px-3 py-2 rounded-lg bg-slate-800 border border-slate-600 text-sm" />

      <div class="flex gap-2">
        <button id="saveLoginChange"
          class="flex-1 bg-amber-400 hover:bg-amber-500 text-black font-semibold rounded-full py-2 text-xs">
          Save
        </button>
        <button id="cancelLoginChange"
          class="flex-1 bg-slate-700 text-gray-100 rounded-full py-2 text-xs">
          Cancel
        </button>
      </div>

      <div id="changeLoginMsg" class="text-[11px] mt-2 text-center text-red-400 hidden"></div>
    </div>
  </div>

  <script>
    const socket = io();

    // LOGIN
    const loginOverlay = document.getElementById("loginOverlay");
    const managerApp = document.getElementById("managerApp");
    const loginBtn = document.getElementById("loginBtn");
    const loginUser = document.getElementById("loginUser");
    const loginPass = document.getElementById("loginPass");
    const loginError = document.getElementById("loginError");

    loginBtn.onclick = async () => {
      const username = loginUser.value.trim();
      const password = loginPass.value.trim();
      loginError.classList.add("hidden");

      if(!username || !password){
        loginError.textContent = "Enter username and password.";
        loginError.classList.remove("hidden");
        return;
      }

      try{
        const res = await fetch("/api/manager/login",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ username, password })
        });
        const data = await res.json();
        if(data.success){
          loginOverlay.style.display = "none";
          managerApp.style.display = "block";
          fetchOrders(getLocalToday());
          renderDashboard();
          await loadInventory();
          // After inventory load, ensure toggle and checkboxes are synced
          syncRestaurantToggleWithInventory();
        }else{
          loginError.textContent = data.message || "Wrong username or password.";
          loginError.classList.remove("hidden");
        }
      }catch(e){
        console.error(e);
        loginError.textContent = "Server error.";
        loginError.classList.remove("hidden");
      }
    };

    // CHANGE LOGIN MODAL
    const openChangeLogin = document.getElementById("openChangeLogin");
    const changeLoginModal = document.getElementById("changeLoginModal");
    const saveLoginChange = document.getElementById("saveLoginChange");
    const cancelLoginChange = document.getElementById("cancelLoginChange");
    const curUser = document.getElementById("curUser");
    const curPass = document.getElementById("curPass");
    const newUser = document.getElementById("newUser");
    const newPass = document.getElementById("newPass");
    const changeLoginMsg = document.getElementById("changeLoginMsg");

    openChangeLogin.onclick = () => {
      changeLoginMsg.classList.add("hidden");
      curUser.value = "";
      curPass.value = "";
      newUser.value = "";
      newPass.value = "";
      changeLoginModal.style.display = "flex";
    };
    cancelLoginChange.onclick = () => {
      changeLoginModal.style.display = "none";
    };
    saveLoginChange.onclick = async () => {
      changeLoginMsg.classList.add("hidden");
      try{
        const res = await fetch("/api/manager/change-credentials",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            currentUser: curUser.value.trim(),
            currentPassword: curPass.value.trim(),
            newUser: newUser.value.trim(),
            newPassword: newPass.value.trim()
          })
        });
        const data = await res.json();
        if(data.success){
          changeLoginMsg.textContent = "Login updated successfully.";
          changeLoginMsg.classList.remove("hidden");
          changeLoginMsg.classList.remove("text-red-400");
          changeLoginMsg.classList.add("text-emerald-400");
          setTimeout(()=>{ changeLoginModal.style.display="none"; }, 1200);
        }else{
          changeLoginMsg.textContent = data.message || "Could not update login.";
          changeLoginMsg.classList.remove("hidden");
          changeLoginMsg.classList.remove("text-emerald-400");
          changeLoginMsg.classList.add("text-red-400");
        }
      }catch(e){
        console.error(e);
        changeLoginMsg.textContent = "Server error.";
        changeLoginMsg.classList.remove("hidden");
        changeLoginMsg.classList.add("text-red-400");
      }
    };

    // ---------- INVENTORY ----------
    let menuData = null;

    async function loadInventory() {
      try{
        const res = await fetch('/menu.json?_=' + Date.now());
        menuData = await res.json();
        const tbody = document.getElementById('inventoryTableBody');
        let rows = '';
        Object.entries(menuData).forEach(([cat, items]) => {
          items.forEach((item, idx) => {
            const rowSpan = idx === 0 ? `rowspan="${items.length}"` : '';
            rows += `
              <tr class="border-b border-slate-700">
                ${idx === 0 ? `<td ${rowSpan} class="py-2 pr-2 align-top text-amber-200 text-xs md:text-sm font-semibold">${cat}</td>` : ''}
                <td class="py-2 pr-2 text-xs md:text-sm text-gray-100">${item.name}</td>
                <td class="py-2 pr-2 text-[11px] md:text-xs text-gray-300">
                  ${Object.entries(item.variants || {}).map(([v,p]) => `${v}: ‚Çπ${p}`).join('<br>')}
                </td>
                <td class="py-2 text-center">
                  <label class="switch">
                    <input type="checkbox" ${item.available !== false ? 'checked' : ''} data-cat="${cat}" data-name="${item.name}">
                    <span class="slider"></span>
                  </label>
                </td>
              </tr>
            `;
          });
        });
        tbody.innerHTML = rows;
      }catch(e){
        console.error(e);
      }
    }

    const saveInventoryBtn = document.getElementById('saveInventoryBtn');
    const inventoryStatus = document.getElementById('inventoryStatus');

    saveInventoryBtn.onclick = async () => {
      if(!menuData) return;
      const switches = document.querySelectorAll('#inventoryTableBody input[type="checkbox"]');
      switches.forEach(sw => {
        const cat = sw.getAttribute('data-cat');
        const name = sw.getAttribute('data-name');
        const items = menuData[cat] || [];
        const item = items.find(i => i.name === name);
        if(item) item.available = sw.checked;
      });
      try{
        await fetch('/update-menu',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(menuData)
        });
        inventoryStatus.textContent = "Menu updated successfully.";
        inventoryStatus.classList.remove('hidden');
        inventoryStatus.classList.remove('text-red-400');
        setTimeout(()=>inventoryStatus.classList.add('hidden'),1500);
      }catch(e){
        console.error(e);
        inventoryStatus.textContent = "Error saving menu.";
        inventoryStatus.classList.remove('hidden');
        inventoryStatus.classList.add('text-red-400');
      }
    };

    // Restaurant ON/OFF affecting inventory checkboxes
    const restStatusToggle = document.getElementById("restStatusToggle");
    const restStatusLabel  = document.getElementById("restStatusLabel");

    function setAllInventoryCheckboxes(checked) {
      const switches = document.querySelectorAll('#inventoryTableBody input[type="checkbox"]');
      switches.forEach(sw => {
        sw.checked = checked;
      });
    }

    function syncRestaurantToggleWithInventory() {
      const switches = document.querySelectorAll('#inventoryTableBody input[type="checkbox"]');
      if(!switches.length) return;
      const allOn = Array.from(switches).every(sw => sw.checked);
      restStatusToggle.checked = allOn;
      restStatusLabel.textContent = allOn
        ? "Restaurant: ON"
        : "Restaurant: OFF (online ordering disabled manually)";
    }

    restStatusToggle.onchange = () => {
      const online = restStatusToggle.checked;
      restStatusLabel.textContent = online
        ? "Restaurant: ON"
        : "Restaurant: OFF (online ordering disabled manually)";
      setAllInventoryCheckboxes(online);
    };

    // Tabs
    const tabOrders    = document.getElementById("tabOrders");
    const tabAnalytics = document.getElementById("tabAnalytics");
    const tabInventory = document.getElementById("tabInventory");
    const ordersTab    = document.getElementById("ordersTab");
    const analyticsTab = document.getElementById("analyticsTab");
    const inventoryTab = document.getElementById("inventoryTab");

    function setActiveTab(which){
      [tabOrders,tabAnalytics,tabInventory].forEach(b=>b.classList.remove("tab-btn-active"));
      [ordersTab,analyticsTab,inventoryTab].forEach(d=>d.style.display="none");
      if(which==="orders"){ tabOrders.classList.add("tab-btn-active"); ordersTab.style.display="block"; }
      if(which==="analytics"){ tabAnalytics.classList.add("tab-btn-active"); analyticsTab.style.display="block"; }
      if(which==="inventory"){ tabInventory.classList.add("tab-btn-active"); inventoryTab.style.display="block"; }
    }
    tabOrders.onclick    = ()=>setActiveTab("orders");
    tabAnalytics.onclick = ()=>setActiveTab("analytics");
    tabInventory.onclick = ()=>setActiveTab("inventory");

    // Date helpers
    function getLocalToday(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const ist = new Date(d.getTime() + (330 + off)*60000);
      return ist.toISOString().slice(0,10);
    }

    const datePicker = document.getElementById("datePicker");
    datePicker.value = getLocalToday();

    const ordersList  = document.getElementById("ordersList");
    const historyList = document.getElementById("historyList");

    // Address + GPS line
    function renderOrderDetails(o) {
      if (o.orderType === "dinein") {
        return o.tableNumber
          ? `<div class="order-card-meta text-gray-300 mt-1">Table: ${o.tableNumber}</div>`
          : "";
      } else {
        if (!o.address && !(o.location && o.location.lat && o.location.lng)) return "";
        let html = `<div class="order-card-meta text-gray-300 mt-1">üìç ${o.address || "‚Äî"}`;
        if (o.location && o.location.lat && o.location.lng) {
          html += `<br><span class="text-[11px] text-amber-300">
            Captured GPS: ${o.location.lat.toFixed(5)}, ${o.location.lng.toFixed(5)}
          </span>`;
        }
        html += `</div>`;
        return html;
      }
    }

    // Open Google Maps with destination = captured GPS
    function openMapsForDelivery(lat, lng) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      window.open(url, "_blank");
    }

    async function fetchOrders(dateStr){
      try{
        const res = await fetch(`/api/orders?date=${dateStr}`);
        const orders = await res.json();

        ordersList.innerHTML = "";
        historyList.innerHTML = "";

        orders.forEach(o=>{
          const card = document.createElement("div");
          card.className = "border border-slate-700 rounded-xl p-3 bg-slate-900/60";

          const typeClass =
            o.orderType === "dinein"   ? "order-type-dinein" :
            o.orderType === "takeaway" ? "order-type-takeaway" :
            "order-type-delivery";

          const itemsText = (o.items||[])
            .map(i=>`${i.name} (${i.variant}) x${i.qty}`)
            .join(", ");

          card.innerHTML = `
            <div class="flex justify-between items-start mb-2 gap-2">
              <div>
                <div class="flex items-center mb-1">
                  <span class="order-type-badge ${typeClass}">
                    ${o.orderType || ""}
                  </span>
                  <span class="order-card-title">
                    ${o.customerName || "No name"} ‚Ä¢ ‚Çπ${o.total || 0}
                  </span>
                </div>
                <div class="order-card-meta text-gray-400">
                  ${o.mobile ? `üìû ${o.mobile} ‚Ä¢ ` : ""}${o.registrationNumber || ""} ${o.tableNumber ? `‚Ä¢ Table ${o.tableNumber}` : ""}
                </div>
                ${renderOrderDetails(o)}
              </div>
              <div class="text-right text-[11px] text-gray-400">
                ${new Date(o.createdAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})}<br>
                <span class="inline-block mt-1 px-2 py-0.5 rounded-full text-[10px] ${
                  o.paymentVerified ? "bg-emerald-500/20 text-emerald-300" : "bg-red-500/20 text-red-300"
                }">
                  ${o.paymentMethod || "COD"} ${o.paymentVerified ? "(PAID)" : "(PENDING)"}
                </span>
              </div>
            </div>
            <div class="order-card-items text-gray-100 mb-2">
              ${itemsText || "No items"}
            </div>
            <div class="flex flex-wrap gap-2 text-[11px]">
              ${
                o.location && o.location.lat && o.location.lng
                  ? `<button
                       class="px-2 py-1 rounded-full border border-amber-400 text-amber-200"
                       onclick="openMapsForDelivery(${o.location.lat},${o.location.lng})">
                       Deliver
                     </button>`
                  : `<button
                       class="px-2 py-1 rounded-full border border-slate-700 text-slate-400"
                       disabled>
                       Deliver
                     </button>`
              }
              <button data-action="status" data-status="delivered"
                class="px-2 py-1 rounded-full border border-slate-600 text-gray-200">
                Delivered
              </button>
              <button data-action="payment"
                class="px-2 py-1 rounded-full border border-emerald-500 text-emerald-300">
                Paid
              </button>
            </div>
          `;

          card.querySelectorAll("button[data-action='status']").forEach(btn=>{
            btn.onclick = async () => {
              const status = btn.getAttribute("data-status");
              try{
                await fetch(`/api/orders/${o._id}/status`,{
                  method:"PATCH",
                  headers:{ "Content-Type":"application/json" },
                  body:JSON.stringify({ status })
                });
              }catch(e){ console.error(e); }
            };
          });

          const paidBtn = card.querySelector("button[data-action='payment']");
          paidBtn.onclick = async () => {
            try{
              await fetch(`/api/orders/${o._id}/payment-verified`,{
                method:"PATCH",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ paymentVerified: !o.paymentVerified })
              });
            }catch(e){ console.error(e); }
          };

          if(o.status === "delivered"){
            historyList.appendChild(card);
          }else{
            ordersList.appendChild(card);
          }
        });
      }catch(e){
        console.error(e);
      }
    }

    // DASHBOARD
    const dashboardPeriod = document.getElementById("dashboardPeriod");
    const dashboardDate   = document.getElementById("dashboardDate");
    dashboardDate.value   = getLocalToday();

    async function renderDashboard() {
      let d = dashboardDate.value, period = dashboardPeriod.value;
      try{
        let r = await fetch(`/api/dashboard/sales?period=${period}&date=${d}`);
        let stats = await r.json();
        document.getElementById('sales-today').textContent = '‚Çπ' + (stats.total || 0);
        document.getElementById('orders-month').textContent = stats.count || 0;

        r = await fetch(`/api/dashboard/peakhour?date=${d}`); let peak = await r.json();
        document.getElementById('peak-hour').textContent = (peak && peak.hour !== "-") ? `${peak.hour}:00` : '-';

        r = await fetch(`/api/dashboard/topdish?date=${d}`); let dish = await r.json();
        document.getElementById('top-dish') && (document.getElementById('top-dish').textContent = dish ? dish._id : '-');
      }catch(e){
        console.error(e);
      }
    }
    dashboardPeriod.onchange = dashboardDate.onchange = renderDashboard;

    // Insights
    const compareBy = document.getElementById('compareBy');
    const compareByLabel = document.getElementById('compareByLabel');
    const insightType = document.getElementById('insightType');
    const insightName = document.getElementById('insightName');

    insightType.onchange = () => {
      if(insightType.value === "compare_sales") compareByLabel.style.display = "";
      else compareByLabel.style.display = "none";
      insightName.style.display = (insightType.value === "customer_search") ? "" : "none";
    }

    async function runInsight() {
      const type = insightType.value,
        from = document.getElementById('insightFrom').value,
        to = document.getElementById('insightTo').value,
        name = insightName.value,
        by = compareBy.value || 'day';
      let html = '';

      try{
        if(type === "compare_sales") {
          let salesA, salesB, labelA, labelB;
          if(by === "day") {
            salesA = await fetch(`/api/dashboard/sales?period=day&date=${from}`).then(r=>r.json());
            salesB = await fetch(`/api/dashboard/sales?period=day&date=${to}`).then(r=>r.json());
            labelA = from || '‚Äî'; labelB = to || '‚Äî';
          } else if(by === "week") {
            salesA = await fetch(`/api/dashboard/sales?period=week&date=${from}`).then(r=>r.json());
            salesB = await fetch(`/api/dashboard/sales?period=week&date=${to}`).then(r=>r.json());
            labelA = `Week of ${from || '‚Äî'}`; labelB = `Week of ${to || '‚Äî'}`;
          } else if(by === "month") {
            salesA = await fetch(`/api/dashboard/sales?period=month&date=${from}`).then(r=>r.json());
            salesB = await fetch(`/api/dashboard/sales?period=month&date=${to}`).then(r=>r.json());
            labelA = `Month: ${(from || '‚Äî').slice(0,7)}`; labelB = `Month: ${(to || '‚Äî').slice(0,7)}`;
          }
          html = `
            <div class="mb-4 flex flex-col md:flex-row items-stretch md:items-center gap-3 md:gap-6">
              <div class="flex-1 bg-yellow-200 rounded-xl p-3 md:p-4 shadow insight-big-value text-center">
                ${labelA}<br>‚Çπ${salesA.total||0}<br>
                <span class="insight-mid-value">Orders: ${salesA.count||0}</span>
              </div>
              <div class="flex-1 bg-yellow-200 rounded-xl p-3 md:p-4 shadow insight-big-value text-center">
                ${labelB}<br>‚Çπ${salesB.total||0}<br>
                <span class="insight-mid-value">Orders: ${salesB.count||0}</span>
              </div>
            </div>`;
          document.getElementById('insightResult').innerHTML = html;
          return;
        }

        if(type === "repeat_customers") {
          const data = await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}`).then(r=>r.json());
          html = `<div class="table-wrapper"><table class="insight-result-table"><thead><tr><th>Name</th><th>Orders</th></tr></thead><tbody>`+
            data.map(c=>`<tr><td>${c._id}</td><td>${c.orders}</td></tr>`).join('')+`</tbody></table></div>`;
        } else if(type === "best_dish") {
          const dish = await fetch(`/api/dashboard/topdish?from=${from}&to=${to}`).then(r=>r.json());
          html = dish
            ? `<div class="text-xl md:text-2xl font-bold text-yellow-800 mb-1">${dish._id}</div><div class="text-sm md:text-lg">Total Orders: <b>${dish.count}</b></div>`
            : '<div class="text-sm text-red-700">No data found in this time frame</div>';
        } else if(type === "customer_search" && name) {
          const data = await fetch(`/api/dashboard/repeatcustomers?from=${from}&to=${to}&name=${encodeURIComponent(name)}`).then(r=>r.json());
          html = data && data.length
            ? `<div class="text-lg md:text-2xl text-yellow-900 font-bold mb-1">${name} visited <span class="font-extrabold text-yellow-900">${data[0].orders}</span> times</div>`
            : `<div class="text-sm text-red-700">${name} did not visit in this period.</div>`;
        } else {
          html = '<div class="text-sm text-red-700">Choose an insight and date(s).</div>';
        }
      }catch(e){
        console.error(e);
        html = '<div class="text-sm text-red-700">Error loading insight data.</div>';
      }
      document.getElementById('insightResult').innerHTML = html;
    }
    window.runInsight = runInsight;

    // Date change: reload orders & dashboard
    datePicker.onchange = () => {
      fetchOrders(datePicker.value);
      renderDashboard();
    };

    socket.on('newOrder', (o) => {
      if ((o.createdAt || '').slice(0,10) === datePicker.value) {
        fetchOrders(datePicker.value);
      }
    });
    socket.on('orderUpdated', () => {
      fetchOrders(datePicker.value);
    });
  </script>
</body>
</html>
